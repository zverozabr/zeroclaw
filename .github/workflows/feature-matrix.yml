name: Feature Matrix

on:
    push:
        branches: [dev, main]
        paths:
            - "Cargo.toml"
            - "Cargo.lock"
            - "src/**"
            - "crates/**"
            - "tests/**"
            - "scripts/ci/nightly_matrix_report.py"
            - ".github/release/nightly-owner-routing.json"
            - ".github/workflows/feature-matrix.yml"
    pull_request:
        branches: [dev, main]
        paths:
            - "Cargo.toml"
            - "Cargo.lock"
            - "src/**"
            - "crates/**"
            - "tests/**"
            - "scripts/ci/nightly_matrix_report.py"
            - ".github/release/nightly-owner-routing.json"
            - ".github/workflows/feature-matrix.yml"
    merge_group:
        branches: [dev, main]
    schedule:
        - cron: "30 4 * * 1" # Weekly Monday 04:30 UTC
        - cron: "15 3 * * *" # Daily 03:15 UTC (nightly profile)
    workflow_dispatch:
        inputs:
            profile:
                description: "compile = merge-gate matrix, nightly = integration-oriented lane commands"
                required: true
                default: compile
                type: choice
                options:
                    - compile
                    - nightly
            fail_on_failure:
                description: "Fail summary job when any lane fails"
                required: true
                default: true
                type: boolean

concurrency:
    group: feature-matrix-${{ github.event.pull_request.number || github.ref || github.run_id }}-${{ github.event.inputs.profile || 'auto' }}
    cancel-in-progress: true

permissions:
    contents: read

env:
    CARGO_TERM_COLOR: always

jobs:
    resolve-profile:
        name: Resolve Matrix Profile
        runs-on: [self-hosted, Linux, X64]
        outputs:
            profile: ${{ steps.resolve.outputs.profile }}
            lane_job_prefix: ${{ steps.resolve.outputs.lane_job_prefix }}
            summary_job_name: ${{ steps.resolve.outputs.summary_job_name }}
            lane_retention_days: ${{ steps.resolve.outputs.lane_retention_days }}
            lane_timeout_minutes: ${{ steps.resolve.outputs.lane_timeout_minutes }}
            max_attempts: ${{ steps.resolve.outputs.max_attempts }}
            summary_artifact_name: ${{ steps.resolve.outputs.summary_artifact_name }}
            summary_json_name: ${{ steps.resolve.outputs.summary_json_name }}
            summary_md_name: ${{ steps.resolve.outputs.summary_md_name }}
            lane_artifact_prefix: ${{ steps.resolve.outputs.lane_artifact_prefix }}
            fail_on_failure: ${{ steps.resolve.outputs.fail_on_failure }}
            collect_history: ${{ steps.resolve.outputs.collect_history }}
        steps:
            - name: Resolve effective profile
              id: resolve
              shell: bash
              run: |
                  set -euo pipefail

                  profile="compile"
                  fail_on_failure="true"
                  lane_job_prefix="Matrix Lane"
                  summary_job_name="Feature Matrix Summary"
                  lane_retention_days="21"
                  lane_timeout_minutes="55"
                  max_attempts="1"
                  summary_artifact_name="feature-matrix-summary"
                  summary_json_name="feature-matrix-summary.json"
                  summary_md_name="feature-matrix-summary.md"
                  lane_artifact_prefix="feature-matrix"
                  collect_history="false"

                  if [ "${GITHUB_EVENT_NAME}" = "schedule" ] && [ "${{ github.event.schedule }}" = "15 3 * * *" ]; then
                    profile="nightly"
                  elif [ "${GITHUB_EVENT_NAME}" = "workflow_dispatch" ]; then
                    profile="${{ github.event.inputs.profile || 'compile' }}"
                    fail_on_failure="${{ github.event.inputs.fail_on_failure || 'true' }}"
                  fi

                  if [ "$profile" = "nightly" ]; then
                    lane_job_prefix="Nightly Lane"
                    summary_job_name="Nightly Summary & Routing"
                    lane_retention_days="30"
                    lane_timeout_minutes="70"
                    max_attempts="2"
                    summary_artifact_name="nightly-all-features-summary"
                    summary_json_name="nightly-summary.json"
                    summary_md_name="nightly-summary.md"
                    lane_artifact_prefix="nightly-lane"
                    collect_history="true"
                  fi

                  {
                    echo "profile=${profile}"
                    echo "lane_job_prefix=${lane_job_prefix}"
                    echo "summary_job_name=${summary_job_name}"
                    echo "lane_retention_days=${lane_retention_days}"
                    echo "lane_timeout_minutes=${lane_timeout_minutes}"
                    echo "max_attempts=${max_attempts}"
                    echo "summary_artifact_name=${summary_artifact_name}"
                    echo "summary_json_name=${summary_json_name}"
                    echo "summary_md_name=${summary_md_name}"
                    echo "lane_artifact_prefix=${lane_artifact_prefix}"
                    echo "fail_on_failure=${fail_on_failure}"
                    echo "collect_history=${collect_history}"
                  } >> "$GITHUB_OUTPUT"

    feature-check:
        name: ${{ needs.resolve-profile.outputs.lane_job_prefix }} (${{ matrix.name }})
        needs: [resolve-profile]
        runs-on: [self-hosted, Linux, X64]
        timeout-minutes: ${{ fromJSON(needs.resolve-profile.outputs.lane_timeout_minutes) }}
        strategy:
            fail-fast: false
            matrix:
                include:
                    - name: default
                      compile_command: cargo check --locked
                      nightly_command: cargo test --locked --test agent_e2e --verbose
                      install_libudev: false
                    - name: whatsapp-web
                      compile_command: cargo check --locked --no-default-features --features whatsapp-web
                      nightly_command: cargo check --locked --no-default-features --features whatsapp-web --verbose
                      install_libudev: false
                    - name: browser-native
                      compile_command: cargo check --locked --no-default-features --features browser-native
                      nightly_command: cargo check --locked --no-default-features --features browser-native --verbose
                      install_libudev: false
                    - name: nightly-all-features
                      compile_command: cargo check --locked --all-features
                      nightly_command: cargo test --locked --all-features --test agent_e2e --verbose
                      install_libudev: true
        steps:
            - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
              with:
                  fetch-depth: 0

            - uses: dtolnay/rust-toolchain@631a55b12751854ce901bb631d5902ceb48146f7 # stable
              with:
                  toolchain: 1.92.0

            - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v3
              with:
                  prefix-key: feature-matrix-${{ matrix.name }}

            - name: Install Linux deps for all-features lane
              if: matrix.install_libudev
              run: |
                  sudo apt-get update -qq
                  sudo apt-get install -y --no-install-recommends libudev-dev pkg-config

            - name: Run matrix lane command
              id: lane
              shell: bash
              run: |
                  set -euo pipefail
                  mkdir -p artifacts

                  profile="${{ needs.resolve-profile.outputs.profile }}"
                  lane_command="${{ matrix.compile_command }}"
                  if [ "$profile" = "nightly" ]; then
                    lane_command="${{ matrix.nightly_command }}"
                  fi

                  max_attempts="${{ needs.resolve-profile.outputs.max_attempts }}"
                  attempt=1
                  status=1

                  started_at="$(date +%s)"
                  while [ "$attempt" -le "$max_attempts" ]; do
                    echo "Running lane command (attempt ${attempt}/${max_attempts}): ${lane_command}"
                    set +e
                    bash -lc "${lane_command}"
                    status=$?
                    set -e
                    if [ "$status" -eq 0 ]; then
                      break
                    fi
                    if [ "$attempt" -lt "$max_attempts" ]; then
                      sleep 5
                    fi
                    attempt="$((attempt + 1))"
                  done
                  finished_at="$(date +%s)"
                  duration="$((finished_at - started_at))"

                  lane_status="success"
                  if [ "$status" -ne 0 ]; then
                    lane_status="failure"
                  fi

                  cat > "artifacts/nightly-result-${{ matrix.name }}.json" <<EOF
                  {
                    "lane": "${{ matrix.name }}",
                    "mode": "${profile}",
                    "status": "${lane_status}",
                    "exit_code": ${status},
                    "duration_seconds": ${duration},
                    "command": "${lane_command}",
                    "attempts_used": ${attempt},
                    "max_attempts": ${max_attempts}
                  }
                  EOF

                  {
                    echo "### ${{ needs.resolve-profile.outputs.lane_job_prefix }}: ${{ matrix.name }}"
                    echo "- Profile: \`${profile}\`"
                    echo "- Command: \`${lane_command}\`"
                    echo "- Status: ${lane_status}"
                    echo "- Exit code: ${status}"
                    echo "- Duration (s): ${duration}"
                    echo "- Attempts: ${attempt}/${max_attempts}"
                  } >> "$GITHUB_STEP_SUMMARY"

                  echo "lane_status=${lane_status}" >> "$GITHUB_OUTPUT"
                  echo "lane_exit_code=${status}" >> "$GITHUB_OUTPUT"

            - name: Upload lane report
              if: always()
              uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
              with:
                  name: ${{ needs.resolve-profile.outputs.lane_artifact_prefix }}-${{ matrix.name }}
                  path: artifacts/nightly-result-${{ matrix.name }}.json
                  if-no-files-found: error
                  retention-days: ${{ fromJSON(needs.resolve-profile.outputs.lane_retention_days) }}

            - name: Enforce lane success
              if: steps.lane.outputs.lane_status != 'success'
              shell: bash
              run: |
                  set -euo pipefail
                  code="${{ steps.lane.outputs.lane_exit_code }}"
                  if [[ "$code" =~ ^[0-9]+$ ]]; then
                    # shellcheck disable=SC2242
                    exit "$code"
                  fi
                  echo "Invalid lane exit code: $code" >&2
                  exit 1

    summary:
        name: ${{ needs.resolve-profile.outputs.summary_job_name }}
        needs: [resolve-profile, feature-check]
        if: always()
        runs-on: [self-hosted, Linux, X64]
        steps:
            - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

            - name: Download lane reports
              uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
              with:
                  path: artifacts

            - name: Collect recent nightly history
              if: needs.resolve-profile.outputs.collect_history == 'true'
              uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
              with:
                  script: |
                    const fs = require("fs");
                    const path = require("path");

                    const workflowId = "feature-matrix.yml";
                    const owner = context.repo.owner;
                    const repo = context.repo.repo;

                    const events = ["schedule", "workflow_dispatch"];
                    let runs = [];
                    for (const event of events) {
                      const resp = await github.rest.actions.listWorkflowRuns({
                        owner,
                        repo,
                        workflow_id: workflowId,
                        branch: "dev",
                        event,
                        per_page: 20,
                      });
                      runs = runs.concat(resp.data.workflow_runs || []);
                    }

                    const currentRunId = context.runId;
                    runs = runs
                      .filter((run) => run.id !== currentRunId && run.status === "completed")
                      .sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime())
                      .slice(0, 3)
                      .map((run) => ({
                        run_id: run.id,
                        url: run.html_url,
                        event: run.event,
                        conclusion: run.conclusion || "unknown",
                        created_at: run.created_at,
                        head_sha: run.head_sha,
                        display_title: run.display_title || "",
                      }));

                    fs.mkdirSync("artifacts", { recursive: true });
                    fs.writeFileSync(
                      path.join("artifacts", "nightly-history.json"),
                      `${JSON.stringify(runs, null, 2)}\n`,
                      { encoding: "utf8" }
                    );

            - name: Aggregate matrix summary
              shell: bash
              run: |
                  set -euo pipefail
                  args=(
                    --input-dir artifacts
                    --owners-file .github/release/nightly-owner-routing.json
                    --output-json "artifacts/${{ needs.resolve-profile.outputs.summary_json_name }}"
                    --output-md "artifacts/${{ needs.resolve-profile.outputs.summary_md_name }}"
                  )

                  if [ "${{ needs.resolve-profile.outputs.collect_history }}" = "true" ] && [ -f artifacts/nightly-history.json ]; then
                    args+=(--history-file artifacts/nightly-history.json)
                  fi

                  if [ "${{ needs.resolve-profile.outputs.fail_on_failure }}" = "true" ]; then
                    args+=(--fail-on-failure)
                  fi

                  python3 scripts/ci/nightly_matrix_report.py "${args[@]}"

            - name: Publish summary
              shell: bash
              run: |
                  set -euo pipefail
                  cat "artifacts/${{ needs.resolve-profile.outputs.summary_md_name }}" >> "$GITHUB_STEP_SUMMARY"

            - name: Upload summary artifact
              if: always()
              uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
              with:
                  name: ${{ needs.resolve-profile.outputs.summary_artifact_name }}
                  path: |
                      artifacts/${{ needs.resolve-profile.outputs.summary_json_name }}
                      artifacts/${{ needs.resolve-profile.outputs.summary_md_name }}
                      artifacts/nightly-history.json
                  if-no-files-found: error
                  retention-days: ${{ fromJSON(needs.resolve-profile.outputs.lane_retention_days) }}
