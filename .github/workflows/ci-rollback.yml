name: CI Rollback Guard

on:
    workflow_dispatch:
        inputs:
            branch:
                description: "Integration branch this rollback targets"
                required: true
                default: dev
                type: choice
                options:
                    - dev
                    - main
            mode:
                description: "dry-run only plans; execute enables rollback marker/dispatch actions"
                required: true
                default: dry-run
                type: choice
                options:
                    - dry-run
                    - execute
            target_ref:
                description: "Optional explicit rollback target (tag/sha/ref). Empty = latest matching tag."
                required: false
                default: ""
                type: string
            allow_non_ancestor:
                description: "Allow target not being ancestor of current head (warning-only)"
                required: true
                default: false
                type: boolean
            fail_on_violation:
                description: "Fail workflow when guard violations are detected"
                required: true
                default: true
                type: boolean
            create_marker_tag:
                description: "In execute mode, create and push rollback marker tag"
                required: true
                default: false
                type: boolean
            emit_repository_dispatch:
                description: "In execute mode, emit repository_dispatch event `rollback_execute`"
                required: true
                default: false
                type: boolean
    schedule:
        - cron: "15 7 * * 1" # Weekly Monday 07:15 UTC

concurrency:
    group: ci-rollback-${{ github.event.inputs.branch || 'dev' }}
    cancel-in-progress: false

permissions:
    contents: read
    actions: read

jobs:
    rollback-plan:
        name: Rollback Guard Plan
        runs-on: [self-hosted, Linux, X64]
        timeout-minutes: 20
        outputs:
            branch: ${{ steps.plan.outputs.branch }}
            mode: ${{ steps.plan.outputs.mode }}
            target_sha: ${{ steps.plan.outputs.target_sha }}
            target_ref: ${{ steps.plan.outputs.target_ref }}
            ready_to_execute: ${{ steps.plan.outputs.ready_to_execute }}
        steps:
            - name: Checkout
              uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
              with:
                  fetch-depth: 0
                  ref: ${{ github.event.inputs.branch || 'dev' }}

            - name: Build rollback plan
              id: plan
              shell: bash
              run: |
                  set -euo pipefail
                  mkdir -p artifacts

                  branch_input="dev"
                  mode_input="dry-run"
                  target_ref_input=""
                  allow_non_ancestor="false"
                  fail_on_violation="true"

                  if [ "${GITHUB_EVENT_NAME}" = "workflow_dispatch" ]; then
                    branch_input="${{ github.event.inputs.branch || 'dev' }}"
                    mode_input="${{ github.event.inputs.mode || 'dry-run' }}"
                    target_ref_input="${{ github.event.inputs.target_ref || '' }}"
                    allow_non_ancestor="${{ github.event.inputs.allow_non_ancestor || 'false' }}"
                    fail_on_violation="${{ github.event.inputs.fail_on_violation || 'true' }}"
                  fi

                  cmd=(python3 scripts/ci/rollback_guard.py
                    --repo-root .
                    --branch "$branch_input"
                    --mode "$mode_input"
                    --strategy latest-release-tag
                    --tag-pattern "v*"
                    --output-json artifacts/rollback-plan.json
                    --output-md artifacts/rollback-plan.md)

                  if [ -n "$target_ref_input" ]; then
                    cmd+=(--target-ref "$target_ref_input")
                  fi
                  if [ "$allow_non_ancestor" = "true" ]; then
                    cmd+=(--allow-non-ancestor)
                  fi
                  if [ "$fail_on_violation" = "true" ]; then
                    cmd+=(--fail-on-violation)
                  fi

                  "${cmd[@]}"

                  target_sha="$(python3 - <<'PY'
                  import json
                  d = json.load(open("artifacts/rollback-plan.json", "r", encoding="utf-8"))
                  print(d.get("target_sha", ""))
                  PY
                  )"
                  target_ref="$(python3 - <<'PY'
                  import json
                  d = json.load(open("artifacts/rollback-plan.json", "r", encoding="utf-8"))
                  print(d.get("target_ref", ""))
                  PY
                  )"
                  ready_to_execute="$(python3 - <<'PY'
                  import json
                  d = json.load(open("artifacts/rollback-plan.json", "r", encoding="utf-8"))
                  print(str(d.get("ready_to_execute", False)).lower())
                  PY
                  )"

                  {
                    echo "branch=$branch_input"
                    echo "mode=$mode_input"
                    echo "target_sha=$target_sha"
                    echo "target_ref=$target_ref"
                    echo "ready_to_execute=$ready_to_execute"
                  } >> "$GITHUB_OUTPUT"

            - name: Emit rollback audit event
              if: always()
              shell: bash
              run: |
                  set -euo pipefail
                  if [ -f artifacts/rollback-plan.json ]; then
                    python3 scripts/ci/emit_audit_event.py \
                      --event-type rollback_guard \
                      --input-json artifacts/rollback-plan.json \
                      --output-json artifacts/audit-event-rollback-guard.json \
                      --artifact-name ci-rollback-plan \
                      --retention-days 21
                  fi

            - name: Upload rollback artifacts
              if: always()
              uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
              with:
                  name: ci-rollback-plan
                  path: |
                      artifacts/rollback-plan.*
                      artifacts/audit-event-rollback-guard.json
                  if-no-files-found: ignore
                  retention-days: 21

            - name: Publish rollback summary
              if: always()
              shell: bash
              run: |
                  set -euo pipefail
                  if [ -f artifacts/rollback-plan.md ]; then
                    cat artifacts/rollback-plan.md >> "$GITHUB_STEP_SUMMARY"
                  else
                    echo "Rollback plan markdown report missing." >> "$GITHUB_STEP_SUMMARY"
                  fi

    rollback-execute:
        name: Rollback Execute Actions
        needs: [rollback-plan]
        if: github.event_name == 'workflow_dispatch' && needs.rollback-plan.outputs.mode == 'execute' && needs.rollback-plan.outputs.ready_to_execute == 'true'
        runs-on: [self-hosted, Linux, X64]
        timeout-minutes: 15
        permissions:
            contents: write
            actions: read
        steps:
            - name: Checkout
              uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
              with:
                  fetch-depth: 0
                  ref: ${{ needs.rollback-plan.outputs.branch }}

            - name: Fetch tags
              shell: bash
              run: |
                  set -euo pipefail
                  git fetch --tags --force origin

            - name: Create rollback marker tag
              id: marker
              if: github.event.inputs.create_marker_tag == 'true'
              shell: bash
              run: |
                  set -euo pipefail
                  target_sha="${{ needs.rollback-plan.outputs.target_sha }}"
                  if [ -z "$target_sha" ]; then
                    echo "Rollback guard did not resolve target_sha."
                    exit 1
                  fi
                  marker_tag="rollback-${{ needs.rollback-plan.outputs.branch }}-${{ github.run_id }}"
                  git tag -a "$marker_tag" "$target_sha" -m "Rollback marker from run ${{ github.run_id }}"
                  git push origin "$marker_tag"
                  echo "marker_tag=$marker_tag" >> "$GITHUB_OUTPUT"

            - name: Emit rollback repository dispatch
              if: github.event.inputs.emit_repository_dispatch == 'true'
              uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
              with:
                  script: |
                      await github.rest.repos.createDispatchEvent({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        event_type: "rollback_execute",
                        client_payload: {
                          branch: "${{ needs.rollback-plan.outputs.branch }}",
                          target_ref: "${{ needs.rollback-plan.outputs.target_ref }}",
                          target_sha: "${{ needs.rollback-plan.outputs.target_sha }}",
                          run_id: context.runId,
                          run_attempt: process.env.GITHUB_RUN_ATTEMPT,
                          source_sha: context.sha
                        }
                      });

            - name: Publish execute summary
              if: always()
              shell: bash
              run: |
                  set -euo pipefail
                  {
                    echo "### Rollback Execute Actions"
                    echo "- Branch: \`${{ needs.rollback-plan.outputs.branch }}\`"
                    echo "- Target ref: \`${{ needs.rollback-plan.outputs.target_ref }}\`"
                    echo "- Target sha: \`${{ needs.rollback-plan.outputs.target_sha }}\`"
                    if [ -n "${{ steps.marker.outputs.marker_tag || '' }}" ]; then
                      echo "- Marker tag: \`${{ steps.marker.outputs.marker_tag }}\`"
                    fi
                  } >> "$GITHUB_STEP_SUMMARY"
